<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Scotland Energy Supply Points</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.5/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<style>
  #map { height: 100vh; width: 100vw; }
  #filter-box {
    position: absolute;
    top: 10px; left: 10px;
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    font-family: sans-serif;
  }
  #filter-box label { display: block; margin-top: 5px; }
</style>
</head>
<body>

<div id="filter-box">
  <label for="techFilter"><b>Primary Technology</b></label>
  <select id="techFilter">
    <option value="">-- Select Technology --</option>
  </select>
  <button id="loadBtn">Load Map</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.5/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

<script>
// ğŸ“Œ OSGB36 to WGS84 tanÄ±mÄ±
proj4.defs("OSGB36", "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs");

// ğŸŒ Harita oluÅŸtur
const map = L.map('map').setView([56, -3.5], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const markers = L.markerClusterGroup();
const csvUrl = "https://heatmap.data.gov.scot/energy-supply-points.csv";

let allData = []; // CSV verisini burada saklayacaÄŸÄ±z

// ğŸ¨ Marker ikonlarÄ±nÄ± oluÅŸtur (renk + boyut)
function createCustomIcon(status, sizeCategory) {
  let color;
  switch (status) {
    case 'Operational': color = 'green'; break;
    case 'In development': color = 'orange'; break;
    case 'Decommissioned': color = 'gray'; break;
    default: color = 'blue';
  }

  let radius;
  if (sizeCategory.includes('Large')) radius = 10;
  else if (sizeCategory.includes('Medium')) radius = 7;
  else radius = 5;

  return L.divIcon({
    html: `<div style="background:${color}; width:${radius*2}px; height:${radius*2}px; border-radius:50%; border:2px solid white;"></div>`,
    className: ''
  });
}

// ğŸ“¥ CSV'yi yÃ¼kle ama markerlarÄ± hemen Ã§izme
Papa.parse(csvUrl, {
  download: true,
  header: true,
  dynamicTyping: true,
  complete: function(results) {
    allData = results.data.filter(d => d.x_Coordinate && d.y_Coordinate);

    // Dropdown'a teknoloji tÃ¼rlerini ekle
    const techSet = new Set(allData.map(d => d.PrimaryTechnology).filter(Boolean));
    const techFilter = document.getElementById('techFilter');
    techSet.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      techFilter.appendChild(opt);
    });
  }
});

// ğŸ§­ Filtreli marker Ã§izimi
function showMarkers(filterTech) {
  markers.clearLayers();
  const filtered = allData.filter(d => d.PrimaryTechnology === filterTech);

  filtered.forEach(d => {
    const [lon, lat] = proj4('OSGB36', 'WGS84', [d.x_Coordinate, d.y_Coordinate]);
    const icon = createCustomIcon(d.StatusDetail || d.Status, d.SizeCategory || '');
    const marker = L.marker([lat, lon], { icon });
    marker.bindPopup(
      `<b>${d.Name || '(No Name)'}</b><br/>
       Tech: ${d.PrimaryTechnology}<br/>
       Status: ${d.StatusDetail}<br/>
       Size: ${d.SizeCategory}`
    );
    markers.addLayer(marker);
  });

  map.addLayer(markers);
  if (filtered.length > 0) {
    map.fitBounds(markers.getBounds());
  }
}

// ğŸš€ "Load Map" butonu
document.getElementById('loadBtn').addEventListener('click', () => {
  const tech = document.getElementById('techFilter').value;
  if (tech) {
    showMarkers(tech);
  } else {
    alert('LÃ¼tfen Ã¶nce bir teknoloji seÃ§in.');
  }
});
</script>

</body>
</html>
