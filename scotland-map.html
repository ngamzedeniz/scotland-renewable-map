<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Scotland Energy Supply Points</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.5/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<style>
  body { margin:0; padding:0; }
  #map { height: 100vh; width: 100vw; }
  #filter-box {
    position: absolute;
    top: 10px; left: 10px;
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    font-family: sans-serif;
  }
  #filter-box label { display: block; margin-top: 5px; }
</style>
</head>
<body>

<div id="filter-box">
  <label for="techFilter"><b>Primary Technology</b></label>
  <select id="techFilter">
    <option value="">-- Select Technology --</option>
  </select>
  <button id="loadBtn">Load Map</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.5/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

<script>
// OSGB36 -> WGS84 dönüşümü
proj4.defs("OSGB36","+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs");

// Harita oluştur
const map = L.map('map').setView([56, -3.5], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const markers = L.markerClusterGroup();

// CSV URL (raw GitHub link)
const csvUrl = "https://raw.githubusercontent.com/ngamzedeniz/scotland-renewable-map/main/energy-supply-points.csv";
let allData = [];

// Marker icon oluştur
function createCustomIcon(status, sizeCategory) {
  let color = 'blue';
  if(status?.toLowerCase().includes('operational')) color='green';
  else if(status?.toLowerCase().includes('development')) color='orange';
  else if(status?.toLowerCase().includes('decommissioned')) color='gray';

  let radius = 5;
  if(sizeCategory?.toLowerCase().includes('large')) radius = 10;
  else if(sizeCategory?.toLowerCase().includes('medium')) radius = 7;

  return L.divIcon({
    html:`<div style="background:${color}; width:${radius*2}px; height:${radius*2}px; border-radius:50%; border:2px solid white;"></div>`,
    className:''
  });
}

// CSV yükle ve dropdown doldur
Papa.parse(csvUrl, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: function(results) {
    allData = results.data.filter(d => d.x_Coordinate && d.y_Coordinate);

    const techSet = new Set(allData.map(d => d.PrimaryTechnology).filter(Boolean));
    const techFilter = document.getElementById('techFilter');
    techSet.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      techFilter.appendChild(opt);
    });
  },
  error: function(err) {
    console.error("CSV yükleme hatası:", err);
    alert("CSV yüklenemedi! Linki ve internet bağlantısını kontrol edin.");
  }
});

// Marker gösterme fonksiyonu
function showMarkers(filterTech) {
  markers.clearLayers();
  const filtered = allData.filter(d => d.PrimaryTechnology === filterTech);

  filtered.forEach(d => {
    const [lon, lat] = proj4('OSGB36','WGS84',[parseFloat(d.x_Coordinate), parseFloat(d.y_Coordinate)]);
    const icon = createCustomIcon(d.StatusDetail || d.Status, d.SizeCategory);
    const marker = L.marker([lat, lon], {icon});
    marker.bindPopup(`
      <b>${d.Name || '(No Name)'}</b><br/>
      Tech: ${d.PrimaryTechnology}<br/>
      Status: ${d.StatusDetail}<br/>
      Size: ${d.SizeCategory}
    `);
    markers.addLayer(marker);
  });

  map.addLayer(markers);
  if(filtered.length>0) map.fitBounds(markers.getBounds());
}

// Load Map butonu
document.getElementById('loadBtn').addEventListener('click', () => {
  const tech = document.getElementById('techFilter').value;
  if(tech) showMarkers(tech);
  else alert('Lütfen önce bir teknoloji seçin.');
});
</script>

</body>
</html>
